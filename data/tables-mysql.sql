START TRANSACTION;

SET foreign_key_checks = 0;

CREATE TABLE IF NOT EXISTS /*#*/config (
	id VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE,
	value TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS /*#*/countries (
	countryid SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	country VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS /*#*/states (
	stateid SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	state VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS /*#*/locations (
	locationid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	countryid SMALLINT UNSIGNED NOT NULL,
	stateid SMALLINT UNSIGNED NOT NULL,
	lat DECIMAL(7,4) NOT NULL,
	lon DECIMAL(7,4) NOT NULL,
	location VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
	UNIQUE (lat, lon),
	FOREIGN KEY (countryid) REFERENCES /*#*/countries(countryid),
	FOREIGN KEY (stateid) REFERENCES /*#*/states(stateid)
);

CREATE TABLE IF NOT EXISTS /*#*/devs (
	devid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	dev VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS /*#*/tags (
	tagid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	tag VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE,
	cat TINYINT UNSIGNED DEFAULT 0 NOT NULL
);

CREATE TABLE IF NOT EXISTS /*#*/users (
	userid SMALLINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
	password VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
	role SMALLINT UNSIGNED NOT NULL,
	token TINYTEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS /*#*/dirs (
	dirid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	dir VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL UNIQUE,
	mt INT UNSIGNED DEFAULT 0 NOT NULL,
	sz BIGINT UNSIGNED DEFAULT 0 NOT NULL,
	qt INT UNSIGNED DEFAULT 0 NOT NULL,
	parentid INT UNSIGNED,
	thm INT UNSIGNED,
	FOREIGN KEY (parentid) REFERENCES /*#*/dirs(dirid) ON DELETE CASCADE,
	FOREIGN KEY (thm) REFERENCES /*#*/files(fileid) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS /*#*/files (
	fileid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	dirid INT UNSIGNED NOT NULL,
	file VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
	ft SMALLINT UNSIGNED DEFAULT 0 NOT NULL,
	sz BIGINT UNSIGNED DEFAULT 0 NOT NULL,
	mt INT UNSIGNED DEFAULT 0 NOT NULL,
	tk INT UNSIGNED DEFAULT 0 NOT NULL,
	fps SMALLINT UNSIGNED DEFAULT 0 NOT NULL,
	dur INT UNSIGNED DEFAULT 0 NOT NULL,
	w INT UNSIGNED DEFAULT 0 NOT NULL,
	h INT UNSIGNED DEFAULT 0 NOT NULL,
	ori TINYINT UNSIGNED DEFAULT 0 NOT NULL,
	lat INT DEFAULT 0 NOT NULL,
	lon INT DEFAULT 0 NOT NULL,
	kw TINYINT UNSIGNED DEFAULT 0 NOT NULL,
	th TINYINT UNSIGNED DEFAULT 2 NOT NULL,
	star TINYINT UNSIGNED DEFAULT 0 NOT NULL,
	locationid INT UNSIGNED,
	devid INT UNSIGNED,
	UNIQUE (dirid, file(255)),
	FOREIGN KEY (dirid) REFERENCES /*#*/dirs(dirid) ON DELETE CASCADE,
	FOREIGN KEY (locationid) REFERENCES /*#*/locations(locationid) ON DELETE SET NULL,
	FOREIGN KEY (devid) REFERENCES /*#*/devs(devid) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS /*#*/albums (
	albumid INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	userid SMALLINT UNSIGNED NOT NULL,
	name VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
	qt INT UNSIGNED DEFAULT 0 NOT NULL,
	mtime INT UNSIGNED DEFAULT 0 NOT NULL,
	share VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci UNIQUE,
	family TINYINT UNSIGNED DEFAULT 0 NOT NULL,
	thm INT UNSIGNED,
	FOREIGN KEY (thm) REFERENCES /*#*/files(fileid) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS /*#*/albumfiles (
	albumid INT UNSIGNED NOT NULL,
	fileid INT UNSIGNED NOT NULL,
	PRIMARY KEY (albumid, fileid),
	FOREIGN KEY (albumid) REFERENCES /*#*/albums(albumid) ON DELETE CASCADE,
	FOREIGN KEY (fileid) REFERENCES /*#*/files(fileid) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS /*#*/tagfiles (
	fileid INT UNSIGNED NOT NULL,
	tagid INT UNSIGNED NOT NULL,
	PRIMARY KEY (fileid, tagid),
	FOREIGN KEY (fileid) REFERENCES /*#*/files(fileid) ON DELETE CASCADE,
	FOREIGN KEY (tagid) REFERENCES /*#*/tags(tagid) ON DELETE CASCADE
);
INSERT IGNORE INTO /*#*/dirs (dirid,dir) VALUES (1,'');

SET foreign_key_checks = 1;

COMMIT;
